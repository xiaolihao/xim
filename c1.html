<!doctype html>
<head>
<script src="jquery.js"></script>
<script src="jquery.form.js"></script>
<style>
form { display: block; margin: 20px auto; background: #eee; border-radius: 10px; padding: 15px }
#progress { position:relative; width:400px; border: 1px solid #ddd; padding: 1px; border-radius: 3px; }
#bar { background-color: #B4F5B4; width:0%; height:20px; border-radius: 3px; }
#percent { position:absolute; display:inline-block; top:3px; left:48%; }
</style>
</head>
<body>
<h1>Ajax File Upload Demo</h1>
<script src="socket.io-client.js"></script>


<form id="myForm" action="http://127.0.0.1:9018/api/v1/upload" method="post" enctype="multipart/form-data">
     <input type="file" size="60" name="myfile">
     <input type="submit" value="Ajax File Upload">
 </form>
 
 
 <div id="progress">
        <div id="bar"></div>
        <div id="percent">0%</div >
</div>
<br/>
    
<div id="message"></div>

<div>
<input  id="m" autocomplete="off" />
<button id="btn">Send</button>
</div>
<script>
$(document).ready(function()
{

    var socket = io('http://localhost:9019');
    var msg={
        action:'init',
        msg:{
          user_id:'1'
        }
      }
    
    socket.emit('message', JSON.stringify(msg));

    socket.on('message', function(msg){
        console.log(msg);
    });

    $('#btn').click(function(){

        var msg={
          action:'message',
          msg:{
            to_user_id: '2',
            from_user_id: '1',
            message_type: 'text',
            message: $('#m').val(),
            timestamp: new Date().toJSON().replace('T', ' ').substr(0, 19)
          }
        }
        socket.emit('message', JSON.stringify(msg));
        $('#m').val('');
        
    });

	var options = { 
        beforeSend: function() 
        {
        	$("#progress").show();
        	$("#bar").width('0%');        	
    		$("#percent").html("0%");
        },
        uploadProgress: function(event, position, total, percentComplete) 
        {
        	$("#bar").width(percentComplete+'%');
        	$("#percent").html(percentComplete+'%');

        
        },
        success: function() 
        {
            $("#bar").width('100%');
        	$("#percent").html('100%');

        },
    	complete: function(response) 
    	{
            //console.log(response);

            var _msg=JSON.parse(response.responseText);
            var msg={
              action:'message',
              msg:{
                to_user_id: '2',
                from_user_id: '1',
                message_type: 'file',
                message: {
                    file_type:_msg.file_type,
                    file_length: _msg.file_length,
                    file_name: _msg.filename,
                    url:_msg.url
                },
                timestamp:_msg.timestamp
              }
            }
            socket.emit('message', JSON.stringify(msg));
            //console.log(JSON.stringify(msg));
    	},
    	error: function()
    	{
            $("<font color='red'> ERROR: unable to upload files</font>").appendTo('#messages');
    	}
     
}; 

    $("#myForm").ajaxForm(options);

});

</script>
</body>


</html>